nextflow_process {

    name "Test Process TAXPASTA_TO_BIOBOXES"
    script "../main.nf"
    process "TAXPASTA_TO_BIOBOXES"

    tag "modules"
    tag "modules_local"
    tag "taxpasta_to_bioboxes"

    test("taxpasta to bioboxes - basic") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'test_sample', sample_id: 'test_1' ],
                    file('${moduleDir}/testdata/test_taxpasta.tsv', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("taxpasta to bioboxes - custom parameters") {

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'test_sample_custom',
                        sample_id: 'custom_sample',
                        ranks: 'domain|phylum|class|order|family|genus|species',
                        taxonomy_db: 'NCBI'
                    ],
                    file('${moduleDir}/testdata/test_taxpasta.tsv', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("taxpasta to bioboxes - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id: 'test_sample', sample_id: 'test_1' ],
                    file('${moduleDir}/testdata/test_taxpasta.tsv', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    // Negative tests - error handling

    test("taxpasta to bioboxes - empty file should fail") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'test_empty', sample_id: 'empty_sample' ],
                    file('${moduleDir}/testdata/test_empty.tsv', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assert process.failed
        }

    }

    test("taxpasta to bioboxes - missing columns should fail") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'test_missing', sample_id: 'missing_sample' ],
                    file('${moduleDir}/testdata/test_missing_columns.tsv', checkIfExists: true)
                ]
                """
            }
        }

        then {
            assert process.failed
        }

    }
}
