nextflow_process {

    name "Test Process OPAL_PER_SAMPLE"
    script "../main.nf"
    process "OPAL_PER_SAMPLE"

    tag "modules"
    tag "modules_local"
    tag "opal_per_sample"

    // Functional tests using realistic data (36+ taxa) to avoid OPAL 1.0.13 visualization bugs
    // Realistic data allows OPAL to generate all outputs including HTML reports

    test("opal_per_sample - single classifier - realistic") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample1' ],
                    file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/prediction_realistic1.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.results.size() == 1 },
                { assert process.out.versions.size() == 1 },
                // OPAL creates results directory with metrics
                { assert path(process.out.results.get(0).get(1)).resolve('results.tsv').exists() }
            )
        }

    }

    test("opal_per_sample - two classifiers - realistic") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample1' ],
                    file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/prediction_realistic1.bioboxes', checkIfExists: true),
                        file('${moduleDir}/testdata/prediction_realistic2.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.results.size() == 1 },
                { assert process.out.versions.size() == 1 },
                { assert path(process.out.results.get(0).get(1)).resolve('results.tsv').exists() },
                { assert path(process.out.results.get(0).get(1)).resolve('confusion.tsv').exists() }
            )
        }

    }

    test("opal_per_sample - three classifiers - realistic") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample1' ],
                    file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/prediction_realistic1.bioboxes', checkIfExists: true),
                        file('${moduleDir}/testdata/prediction_realistic2.bioboxes', checkIfExists: true),
                        file('${moduleDir}/testdata/prediction_realistic3.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.results.size() == 1 },
                { assert process.out.versions.size() == 1 },
                { assert path(process.out.results.get(0).get(1)).resolve('results.tsv').exists() },
                { assert path(process.out.results.get(0).get(1)).resolve('by_rank').exists() }
            )
        }

    }

    test("opal_per_sample - custom labels - realistic") {

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        labels: 'Kraken2,MetaPhlAn'
                    ],
                    file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/prediction_realistic1.bioboxes', checkIfExists: true),
                        file('${moduleDir}/testdata/prediction_realistic2.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.results.size() == 1 },
                { assert process.out.versions.size() == 1 }
            )
        }

    }

    test("opal_per_sample - with optional parameters - realistic") {

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        filter: 0.01,
                        normalize: true,
                        rank: 'species'
                    ],
                    file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/prediction_realistic1.bioboxes', checkIfExists: true),
                        file('${moduleDir}/testdata/prediction_realistic2.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert process.out.results.size() == 1 },
                { assert process.out.versions.size() == 1 }
            )
        }

    }

    // Stub test for CI/CD environments where full OPAL execution is not needed
    test("opal_per_sample - stub") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample1' ],
                    file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/prediction1.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    // Negative tests - error handling
    // Note: These tests verify that OPAL fails gracefully with invalid inputs

    test("opal_per_sample - empty gold standard should fail") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample_empty_gs' ],
                    file('${moduleDir}/testdata/empty_gold_standard.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/prediction_realistic1.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assert process.failed
        }

    }

    test("opal_per_sample - empty prediction should fail") {

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample_empty_pred' ],
                    file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true),
                    [
                        file('${moduleDir}/testdata/empty_prediction.bioboxes', checkIfExists: true)
                    ]
                ]
                """
            }
        }

        then {
            assert process.failed
        }

    }
}
