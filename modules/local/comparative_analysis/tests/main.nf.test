nextflow_process {

    name "Test Process COMPARATIVE_ANALYSIS"
    script "../main.nf"
    process "COMPARATIVE_ANALYSIS"

    tag "modules"
    tag "modules_local"
    tag "comparative_analysis"

    // NOTE: COMPARATIVE_ANALYSIS requires pandas, scikit-learn, plotly, scipy, and statsmodels
    // for full statistical analysis. These dependencies may not be available in all test environments.
    // Stub tests verify module structure and output channels without requiring the full dependency stack.
    // Functional tests require -profile conda or wave for dependency installation.

    test("comparative_analysis - functional - realistic data") {

        tag "conda"
        tag "wave"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        sample_id: 'sample1',
                        labels: 'kraken2,metaphlan,centrifuge',
                        num_classifiers: 3
                    ],
                    file('${moduleDir}/testdata/opal_results_realistic', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(
                    process.out.pca_plot,
                    process.out.diff_taxa,
                    process.out.comparison_report,
                    process.out.versions
                ).match() }
            )
        }

    }

    test("comparative_analysis - stub - basic") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample1' ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("comparative_analysis - stub - with sample_id") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        sample_id: 'test_sample'
                    ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("comparative_analysis - stub - with labels") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        sample_id: 'test_sample',
                        labels: 'Kraken2,MetaPhlAn'
                    ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("comparative_analysis - stub - custom prefix") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id: 'custom_id' ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }
}
