nextflow_process {

    name "Test Process COMPARATIVE_ANALYSIS"
    script "../main.nf"
    process "COMPARATIVE_ANALYSIS"

    tag "modules"
    tag "modules_local"
    tag "comparative_analysis"

    // NOTE: COMPARATIVE_ANALYSIS requires pandas, scikit-learn, plotly, scipy, and statsmodels
    // for full statistical analysis. These dependencies may not be available in all test environments.
    // Stub tests verify module structure and output channels without requiring the full dependency stack.
    // Functional tests require -profile conda or wave for dependency installation.

    test("comparative_analysis - functional - realistic data") {

        tag "conda"
        tag "wave"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        sample_id: 'sample1',
                        labels: 'kraken2,metaphlan,centrifuge',
                        num_classifiers: 3
                    ],
                    file('${moduleDir}/testdata/opal_results_realistic', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                // Snapshot PCA and diff_taxa outputs (deterministic)
                { assert snapshot(
                    process.out.pca_plot,
                    process.out.diff_taxa,
                    process.out.versions
                ).match() },
                // Verify comparison report exists but don't snapshot MD5 (Plotly HTML is non-deterministic)
                { assert process.out.comparison_report.size() == 1 },
                { assert process.out.comparison_report.get(0).get(0).id == 'sample1' },
                { assert file(process.out.comparison_report.get(0).get(1)).name.endsWith('_comparison.html') }
            )
        }

    }

    test("comparative_analysis - stub - basic") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id: 'sample1' ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("comparative_analysis - stub - with sample_id") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        sample_id: 'test_sample'
                    ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("comparative_analysis - stub - with labels") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample1',
                        sample_id: 'test_sample',
                        labels: 'Kraken2,MetaPhlAn'
                    ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    test("comparative_analysis - stub - custom prefix") {

        options "-stub"

        when {
            process {
                """
                input[0] = [
                    [ id: 'custom_id' ],
                    file('${moduleDir}/testdata/opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            assertAll(
                { assert process.success },
                { assert snapshot(process.out).match() }
            )
        }

    }

    // Negative tests - error handling

    test("comparative_analysis - empty opal results handles gracefully") {

        tag "conda"
        tag "wave"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample_empty',
                        sample_id: 'empty_sample',
                        labels: 'test1,test2',
                        num_classifiers: 2
                    ],
                    file('${moduleDir}/testdata/empty_opal_results', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            // Empty OPAL results should still complete but with limited output
            assertAll(
                { assert process.success },
                { assert process.out.versions.size() == 1 }
            )
        }

    }

    test("comparative_analysis - single classifier warning") {

        tag "conda"
        tag "wave"

        when {
            process {
                """
                input[0] = [
                    [
                        id: 'sample_single',
                        sample_id: 'single_sample',
                        labels: 'single_classifier',
                        num_classifiers: 1
                    ],
                    file('${moduleDir}/testdata/opal_results_realistic', checkIfExists: true)
                ]
                input[1] = file('${moduleDir}/testdata/gold_standard_realistic.bioboxes', checkIfExists: true)
                """
            }
        }

        then {
            // Single classifier runs should still succeed but may produce limited output
            assertAll(
                { assert process.success },
                { assert process.out.versions.size() == 1 }
            )
        }

    }
}
