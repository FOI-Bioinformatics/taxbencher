# FOI-Bioinformatics/taxbencher

[![GitHub Actions CI Status](https://github.com/FOI-Bioinformatics/taxbencher/actions/workflows/nf-test.yml/badge.svg)](https://github.com/FOI-Bioinformatics/taxbencher/actions/workflows/nf-test.yml)
[![GitHub Actions Linting Status](https://github.com/FOI-Bioinformatics/taxbencher/actions/workflows/linting.yml/badge.svg)](https://github.com/FOI-Bioinformatics/taxbencher/actions/workflows/linting.yml)[![Cite with Zenodo](http://img.shields.io/badge/DOI-10.5281/zenodo.XXXXXXX-1073c8?labelColor=000000)](https://doi.org/10.5281/zenodo.XXXXXXX)
[![nf-test](https://img.shields.io/badge/unit_tests-nf--test-337ab7.svg)](https://www.nf-test.com)

[![Nextflow](https://img.shields.io/badge/version-%E2%89%A524.10.5-green?style=flat&logo=nextflow&logoColor=white&color=%230DC09D&link=https%3A%2F%2Fnextflow.io)](https://www.nextflow.io/)
[![nf-core template version](https://img.shields.io/badge/nf--core_template-3.3.2-green?style=flat&logo=nfcore&logoColor=white&color=%2324B064&link=https%3A%2F%2Fnf-co.re)](https://github.com/nf-core/tools/releases/tag/3.3.2)
[![run with conda](http://img.shields.io/badge/run%20with-conda-3EB049?labelColor=000000&logo=anaconda)](https://docs.conda.io/en/latest/)
[![run with docker](https://img.shields.io/badge/run%20with-docker-0db7ed?labelColor=000000&logo=docker)](https://www.docker.com/)
[![run with singularity](https://img.shields.io/badge/run%20with-singularity-1d355c.svg?labelColor=000000)](https://sylabs.io/docs/)
[![Launch on Seqera Platform](https://img.shields.io/badge/Launch%20%F0%9F%9A%80-Seqera%20Platform-%234256e7)](https://cloud.seqera.io/launch?pipeline=https://github.com/FOI-Bioinformatics/taxbencher)

## Introduction

**FOI-Bioinformatics/taxbencher** is a bioinformatics pipeline that benchmarks taxonomic classifiers by evaluating their predictions against known ground truth. It accepts standardized taxpasta profiles (typically generated by nf-core/taxprofiler) and uses the CAMI OPAL evaluation framework to compute comprehensive performance metrics. The pipeline produces HTML reports with precision, recall, F1 scores, UniFrac distances, and other metrics to help researchers compare and select the best taxonomic classification tools for their data.

**Pipeline steps:**

1. Convert taxpasta profiles to CAMI Bioboxes format ([`TAXPASTA_TO_BIOBOXES`](modules/local/taxpasta_to_bioboxes/))
2. Evaluate predictions against gold standard ([`OPAL`](https://github.com/CAMI-challenge/OPAL))
3. Aggregate results ([`MultiQC`](http://multiqc.info/))

## Features

- **Standardized Format Conversion**: Converts taxpasta TSV to CAMI Bioboxes format
- **Comprehensive Metrics**: Precision, recall, F1, UniFrac, Shannon diversity, Bray-Curtis, and more
- **Built-in Validation**: Pre-flight validation tools for taxpasta and bioboxes formats
- **nf-core Compliance**: Built using nf-core template with best practices
- **Containerized**: Docker, Singularity, and Conda support for reproducibility
- **Extensive Testing**: Full nf-test suite with validated test data
- **Integration Ready**: Works seamlessly with nf-core/taxprofiler outputs

## Usage

> [!NOTE]
> If you are new to Nextflow and nf-core, please refer to [this page](https://nf-co.re/docs/usage/installation) on how to set-up Nextflow. Make sure to [test your setup](https://nf-co.re/docs/usage/introduction#how-to-run-a-pipeline) with `-profile test` before running the workflow on actual data.

First, prepare a samplesheet with your input data that looks as follows:

`samplesheet.csv`:

```csv
sample,classifier,taxpasta_file,taxonomy_db
sample1,kraken2,results/taxprofiler/sample1_kraken2.tsv,NCBI
sample1,metaphlan,results/taxprofiler/sample1_metaphlan.tsv,NCBI
```

Each row represents a taxpasta profile from a specific classifier for a given sample.

> [!NOTE]
> Taxpasta files are generated by [nf-core/taxprofiler](https://nf-co.re/taxprofiler). Run taxprofiler first to generate taxonomic profiles in standardized format.

> [!TIP]
> **Always validate your input files before running the pipeline:**
> ```bash
> # Validate taxpasta files
> python3 bin/validate_taxpasta.py sample1_kraken2.tsv
>
> # Validate gold standard (CRITICAL - catches column mismatches and unsupported ranks)
> python3 bin/validate_bioboxes.py gold_standard.bioboxes
>
> # If validation fails, automatically fix common issues:
> python3 bin/fix_gold_standard.py \
>   -i gold_standard.bioboxes \
>   -o gold_standard_fixed.bioboxes \
>   -s sample_id
> ```
> See **[Gold Standard Troubleshooting](docs/troubleshooting-gold-standard.md)** for detailed validation and fixing guide.

Now, you can run the pipeline using:

```bash
nextflow run FOI-Bioinformatics/taxbencher \
   -profile <docker/singularity/conda/.../institute> \
   --input samplesheet.csv \
   --gold_standard gold_standard.bioboxes \
   --outdir <OUTDIR>
```

### Recommended Profiles

| Platform | Recommended Profile | Notes |
|----------|-------------------|-------|
| **Linux x86_64** | `docker,wave` or `singularity,wave` | Best performance, full functionality |
| **Linux ARM64** | `conda` | Docker/Singularity containers are AMD64 only |
| **macOS (Intel)** | `docker,wave` or `conda` | Full functionality |
| **macOS (Apple Silicon)** | `conda` | ⚠️ **Docker has limitations** (see below) |
| **HPC/Cluster** | `singularity` or `conda` | Depends on cluster configuration |

> [!WARNING]
> **Apple Silicon (M1/M2/M3) Limitations**: When using `-profile docker,wave` on Apple Silicon Macs, the MultiQC step may fail with "Illegal instruction" errors due to AMD64/ARM64 architecture incompatibility. The core benchmarking processes (TAXPASTA_STANDARDISE, TAXPASTA_TO_BIOBOXES, OPAL) work correctly and produce all evaluation metrics. **Recommended solution**: Use `-profile conda` on Apple Silicon for full compatibility.

### Profile Details

**Conda** (Recommended for macOS):
```bash
nextflow run FOI-Bioinformatics/taxbencher \
   -profile conda \
   --input samplesheet.csv \
   --gold_standard gold_standard.bioboxes \
   --outdir results
```

**Docker with Wave** (Linux/Intel Mac):
```bash
nextflow run FOI-Bioinformatics/taxbencher \
   -profile docker,wave \
   --input samplesheet.csv \
   --gold_standard gold_standard.bioboxes \
   --outdir results
```

**Singularity with Wave** (HPC/Linux):
```bash
nextflow run FOI-Bioinformatics/taxbencher \
   -profile singularity,wave \
   --input samplesheet.csv \
   --gold_standard gold_standard.bioboxes \
   --outdir results
```

> [!WARNING]
> Please provide pipeline parameters via the CLI or Nextflow `-params-file` option. Custom config files including those provided by the `-c` Nextflow option can be used to provide any configuration _**except for parameters**_; see [docs](https://nf-co.re/docs/usage/getting_started/configuration#custom-configuration-files).

## Documentation

For detailed information, see:

- **[Usage Guide](docs/usage.md)** - Complete usage instructions, parameters, and configuration
- **[Output Files](docs/output.md)** - Description of output files and OPAL metrics interpretation
- **[Gold Standard Troubleshooting](docs/troubleshooting-gold-standard.md)** - **NEW!** Validate and fix gold standard files
- **[Validation Tools](docs/local_testing.md#validation-scripts)** - Pre-flight validation scripts and local testing
- **[Developer Guide](CLAUDE.md)** - Architecture, development patterns, and contributing
- **[Validation Report](VALIDATION_REPORT.md)** - Technical validation and test coverage details

## Credits

FOI-Bioinformatics/taxbencher was originally written by Andreas Sjödin.

We thank the following people for their extensive assistance in the development of this pipeline:

<!-- TODO nf-core: If applicable, make list of people who have also contributed -->

## Contributions and Support

If you would like to contribute to this pipeline, please see the [contributing guidelines](.github/CONTRIBUTING.md).

## Citations

<!-- TODO nf-core: Add citation for pipeline after first release. Uncomment lines below and update Zenodo doi and badge at the top of this file. -->
<!-- If you use FOI-Bioinformatics/taxbencher for your analysis, please cite it using the following doi: [10.5281/zenodo.XXXXXX](https://doi.org/10.5281/zenodo.XXXXXX) -->

An extensive list of references for the tools used by the pipeline can be found in the [`CITATIONS.md`](CITATIONS.md) file.

Key tools used in this pipeline:

- **OPAL** (CAMI taxonomic profiling evaluation)
  > Meyer F, Hofmann P, Belmann P, et al. AMBER: Assessment of Metagenome BinnERs. _GigaScience_. 2018;7(6). doi: [10.1093/gigascience/giy069](https://doi.org/10.1093/gigascience/giy069)

- **taxpasta** (Taxonomic profile standardization)
  > Beber ME, Borry M, Stamouli S, Fellows Yates JA. taxpasta: TAXonomic Profile Aggregation and STAndardisation. _Journal of Open Source Software_. 2023;8(87):5627. doi: [10.21105/joss.05627](https://doi.org/10.21105/joss.05627)

This pipeline uses code and infrastructure developed and maintained by the [nf-core](https://nf-co.re) community, reused here under the [MIT license](https://github.com/nf-core/tools/blob/main/LICENSE).

> **The nf-core framework for community-curated bioinformatics pipelines.**
>
> Philip Ewels, Alexander Peltzer, Sven Fillinger, Harshil Patel, Johannes Alneberg, Andreas Wilm, Maxime Ulysse Garcia, Paolo Di Tommaso & Sven Nahnsen.
>
> _Nat Biotechnol._ 2020 Feb 13. doi: [10.1038/s41587-020-0439-x](https://dx.doi.org/10.1038/s41587-020-0439-x).
